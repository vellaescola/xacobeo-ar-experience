<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xacobeo AR - Admin Panel</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .stitch-card { background: #1e293b; border-radius: 16px; border: 1px solid #334155; }
        .accent-lavender { background-color: #6366f1; }
        .accent-emerald { background-color: #10b981; }
        input[type=range] { accent-color: #6366f1; }
    </style>
</head>
<body class="p-4">
    <div class="stitch-card p-4 mb-6">
        <h2 class="text-xs font-bold uppercase text-slate-400 mb-2">Configuración de Seguridad</h2>
        <input type="password" id="gh-token" placeholder="Pega tu Token ghp_..." 
               class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm">
        <button onclick="saveToken()" class="mt-2 text-xs text-indigo-400 underline">Guardar en este dispositivo</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="stitch-card overflow-hidden">
            <div class="h-64 bg-black relative">
                <a-scene embedded style="height: 100%; width: 100%">
                    <a-sky color="#0f172a"></a-sky>
                    <a-plane position="0 0 0" rotation="-90 0 0" width="4" height="4" color="#1e293b"></a-plane>
                    <a-entity id="preview-model" gltf-model="url(https://vellaescola.github.io/xacobeo-ar-experience/modelo.glb)" position="0 0.5 0"></a-entity>
                    <a-entity camera position="0 2 4" look-controls></a-entity>
                </a-scene>
            </div>
            <div class="p-4 space-y-4">
                <h3 class="font-bold">Ajustes de Escena</h3>
                <div><label class="text-xs text-slate-400">Altura (Y)</label>
                <input type="range" id="posY" min="-1" max="4" step="0.1" value="0.5" class="w-full" oninput="updatePreview()"></div>
                <div><label class="text-xs text-slate-400">Escala</label>
                <input type="range" id="scale" min="0.1" max="3" step="0.1" value="1" class="w-full" oninput="updatePreview()"></div>
                <div><label class="text-xs text-slate-400">Giro (Rotación Y)</label>
                <input type="range" id="rotY" min="0" max="360" step="1" value="0" class="w-full" oninput="updatePreview()"></div>
            </div>
        </div>

        <div class="flex flex-col justify-center">
            <div class="stitch-card p-8 text-center">
                <div class="mb-4 text-4xl">✨</div>
                <h2 class="text-xl font-bold mb-2">Publicar Cambios</h2>
                <p class="text-sm text-slate-400 mb-6">Al pulsar, actualizaremos el index.html de tu repositorio automáticamente.</p>
                <button onclick="publish()" id="btn-pub" class="w-full accent-lavender hover:opacity-90 py-4 rounded-2xl font-bold transition-all">
                    ACTUALIZAR REPOSITORIO
                </button>
                <p id="log" class="mt-4 text-xs font-mono text-slate-500"></p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
        function saveToken() { localStorage.setItem('gh_token', document.getElementById('gh-token').value); alert("Token guardado"); }

        function updatePreview() {
            const y = document.getElementById('posY').value;
            const s = document.getElementById('scale').value;
            const r = document.getElementById('rotY').value;
            const mod = document.getElementById('preview-model');
            mod.setAttribute('position', `0 ${y} 0`);
            mod.setAttribute('scale', `${s} ${s} ${s}`);
            mod.setAttribute('rotation', `0 ${r} 0`);
        }

        async function publish() {
            const token = document.getElementById('gh-token').value;
            const log = document.getElementById('log');
            if(!token) return alert("Falta el Token");

            log.innerText = "⏳ Conectando con GitHub...";
            try {
                const repo = 'vellaescola/xacobeo-ar-experience';
                const url = `https://api.github.com/repos/${repo}/contents/index.html`;
                
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                const data = await res.json();
                let content = atob(data.content);

                const y = document.getElementById('posY').value;
                const s = document.getElementById('scale').value;
                const r = document.getElementById('rotY').value;
                
                // Reemplazo inteligente basado en la ID
                const regex = /id="modelo-ar"\s+position=".*?"\s+rotation=".*?"\s+scale=".*?"/;
                const newAttr = `id="modelo-ar" position="0 ${y} 0" rotation="0 ${r} 0" scale="${s} ${s} ${s}"`;
                content = content.replace(regex, newAttr);

                const update = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Update AR coords via Admin Panel",
                        content: btoa(content),
                        sha: data.sha
                    })
                });

                if(update.ok) {
                    log.innerText = "✅ ¡Éxito! Tu App AR se está actualizando.";
                    document.getElementById('btn-pub').classList.replace('accent-lavender', 'accent-emerald');
                }
            } catch (e) { log.innerText = "❌ Error: " + e.message; }
        }
    </script>
</body>
</html>
