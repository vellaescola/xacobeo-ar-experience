<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xacobeo AR - Admin Final Fix</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-orbit-controls@1.3.2/dist/aframe-orbit-controls.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .stitch-card { background: #1e293b; border-radius: 16px; border: 1px solid #334155; margin-bottom: 1rem; }
        input[type=range] { accent-color: #6366f1; height: 8px; width: 100%; }
        .btn-view { background: #334155; padding: 10px; border-radius: 8px; font-size: 10px; font-weight: bold; color: white; }
    </style>
</head>
<body class="p-4">

    <div class="stitch-card p-4">
        <h2 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Paso 1: Configuraci√≥n</h2>
        <input type="password" id="gh-token" placeholder="Pega aqu√≠ tu token ghp_..." class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white mb-3">
        <div class="flex gap-2">
            <label class="flex-1 bg-indigo-600 p-3 rounded text-[10px] text-center cursor-pointer font-bold uppercase">üìÅ Cargar GLB<input type="file" accept=".glb" class="hidden" onchange="handleFile(this, 'model')"></label>
            <label class="flex-1 bg-indigo-600 p-3 rounded text-[10px] text-center cursor-pointer font-bold uppercase">üñºÔ∏è Cargar Target<input type="file" accept="image/*" class="hidden" onchange="handleFile(this, 'target')"></label>
        </div>
    </div>

    <div class="stitch-card overflow-hidden">
        <div class="h-80 bg-black relative">
            <div class="absolute top-2 left-2 z-50 flex gap-1">
                <button onclick="setView('top')" class="btn-view">CENITAL</button>
                <button onclick="setView('front')" class="btn-view">FRONTAL</button>
            </div>
            <a-scene embedded style="height: 100%; width: 100%" vr-mode-ui="enabled: false">
                <a-sky color="#0f172a"></a-sky>
                <a-image id="ground-img" position="0 0 0" rotation="-90 0 0" width="4" height="4" visible="false"></a-image>
                <a-entity id="preview-entity" gltf-model="" position="0 0.1 0" rotation="0 0 0" scale="1 1 1"></a-entity>
                <a-entity id="cam" camera orbit-controls="target: 0 0.1 0; initialPosition: 0 2 5;"></a-entity>
            </a-scene>
        </div>

        <div class="p-4 space-y-4 bg-slate-900/40">
            <select id="target-index" class="w-full bg-slate-800 border border-slate-700 p-3 rounded text-sm font-bold text-indigo-300">
                <option value="0">Modelo en Target 0 (Silla)</option>
                <option value="1">Modelo en Target 1 (Tripo)</option>
            </select>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-[10px] text-slate-400">ALTURA Y: <span id="val-y">0.1</span></label>
                <input type="range" id="posY" min="-1" max="3" step="0.01" value="0.1" oninput="apply()"></div>
                <div><label class="text-[10px] text-slate-400">ESCALA: <span id="val-s">1.0</span></label>
                <input type="range" id="scale" min="0.1" max="10" step="0.1" value="1" oninput="apply()"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-[10px] text-indigo-400 font-bold uppercase">ROTACI√ìN X: <span id="val-rx">0</span>¬∞</label>
                <input type="range" id="rotX" min="0" max="360" step="1" value="0" oninput="apply()"></div>
                <div><label class="text-[10px] text-indigo-400 font-bold uppercase">GIRO Y: <span id="val-ry">0</span>¬∞</label>
                <input type="range" id="rotY" min="0" max="360" step="1" value="0" oninput="apply()"></div>
            </div>
        </div>
    </div>

    <div class="p-4">
        <button onclick="publish()" id="btn-pub" class="bg-indigo-500 w-full py-4 rounded-2xl font-bold text-lg shadow-xl active:bg-indigo-700">
            üöÄ GUARDAR CAMBIOS
        </button>
        <p id="status" class="text-center text-xs mt-4 font-mono text-slate-400 uppercase tracking-widest">Listo</p>
    </div>

    <script>
        document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';

        function handleFile(input, type) {
            const file = input.files[0]; if (!file) return;
            if(type === 'model') document.getElementById('preview-entity').setAttribute('gltf-model', URL.createObjectURL(file));
            else {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('ground-img').setAttribute('src', e.target.result); document.getElementById('ground-img').setAttribute('visible', 'true'); };
                reader.readAsDataURL(file);
            }
        }

        function setView(view) {
            const cam = document.getElementById('cam');
            if(view === 'top') cam.setAttribute('position', '0 6 0');
            if(view === 'front') cam.setAttribute('position', '0 0.5 5');
        }

        function apply() {
            const y = document.getElementById('posY').value, s = document.getElementById('scale').value;
            const rx = document.getElementById('rotX').value, ry = document.getElementById('rotY').value;
            document.getElementById('val-y').innerText = y; document.getElementById('val-s').innerText = s;
            document.getElementById('val-rx').innerText = rx; document.getElementById('val-ry').innerText = ry;
            const ent = document.getElementById('preview-entity');
            ent.setAttribute('position', `0 ${y} 0`); ent.setAttribute('scale', `${s} ${s} ${s}`); ent.setAttribute('rotation', `${rx} ${ry} 0`);
        }

        async function publish() {
            const token = document.getElementById('gh-token').value.trim();
            const targetIdx = document.getElementById('target-index').value;
            const status = document.getElementById('status');
            const btn = document.getElementById('btn-pub');

            if(!token) return alert("Error: Falta el Token");
            localStorage.setItem('gh_token', token);
            
            btn.disabled = true;
            status.innerHTML = "‚è≥ CONECTANDO...";

            try {
                const repo = 'vellaescola/xacobeo-ar-experience';
                const path = 'index.html';
                
                // 1. Obtener archivo (GET)
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'GET',
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });

                if(!getRes.ok) throw new Error("Error de conexi√≥n. Revisa el Token.");
                const data = await getRes.json();
                
                // Decodificar contenido
                let html = decodeURIComponent(escape(atob(data.content.replace(/\s/g, ''))));

                // Nuevos valores
                const y = document.getElementById('posY').value, s = document.getElementById('scale').value;
                const rx = document.getElementById('rotX').value, ry = document.getElementById('rotY').value;

                // Regex para buscar por targetIndex
                const regex = new RegExp(`(targetIndex:\\s*${targetIdx}[\\s\\S]*?position=")([^"]*)("[\\s\\S]*?rotation=")([^"]*)("[\\s\\S]*?scale=")([^"]*)(")`, 'i');

                if(!regex.test(html)) throw new Error(`No se encontr√≥ el bloque del Target ${targetIdx}`);

                // Reemplazar
                const newHtml = html.replace(regex, `$10 ${y} 0$3${rx} ${ry} 0$5${s} ${s} ${s}$7`);
                
                // Codificar a Base64
                const base64Content = btoa(unescape(encodeURIComponent(newHtml)));

                status.innerHTML = "üöÄ ENVIANDO DATOS...";

                // 2. Subir archivo (PUT)
                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Admin: Update Target ${targetIdx}`,
                        content: base64Content,
                        sha: data.sha
                    })
                });

                if(putRes.ok) {
                    status.innerHTML = "<span class='text-emerald-400'>‚úÖ ¬°√âXITO! GUARDADO</span>";
                } else {
                    const err = await putRes.json();
                    throw new Error(err.message);
                }

            } catch (e) {
                status.innerHTML = `<span class='text-red-500'>‚ùå ERROR: ${e.message}</span>`;
                console.error(e);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
