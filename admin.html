<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xacobeo AR - Admin Panel</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .stitch-card { background: #1e293b; border-radius: 16px; border: 1px solid #334155; }
        .accent-lavender { background-color: #6366f1; }
        .accent-emerald { background-color: #10b981; }
        input[type=range] { accent-color: #6366f1; }
    </style>
</head>
<body class="p-4">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="stitch-card p-4">
            <h2 class="text-xs font-bold uppercase text-slate-400 mb-2">Seguridad (GitHub Token)</h2>
            <input type="password" id="gh-token" placeholder="ghp_..." class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-white">
            <button onclick="saveToken()" class="mt-2 text-xs text-indigo-400 underline">Guardar en este dispositivo</button>
        </div>
        <div class="stitch-card p-4">
            <h2 class="text-xs font-bold uppercase text-slate-400 mb-2">Cargar Archivos (Previsualizaci√≥n)</h2>
            <div class="flex gap-2">
                <label class="flex-1 bg-slate-700 hover:bg-slate-600 p-2 rounded text-xs text-center cursor-pointer transition-colors">
                    üìÅ Cargar GLB
                    <input type="file" id="load-glb" accept=".glb" class="hidden" onchange="handleFile(this, 'model')">
                </label>
                <label class="flex-1 bg-slate-700 hover:bg-slate-600 p-2 rounded text-xs text-center cursor-pointer transition-colors">
                    üñºÔ∏è Cargar Target
                    <input type="file" id="load-img" accept="image/*" class="hidden" onchange="handleFile(this, 'target')">
                </label>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="stitch-card overflow-hidden">
            <div class="h-80 bg-black relative">
                <a-scene embedded style="height: 100%; width: 100%">
                    <a-sky color="#0f172a"></a-sky>
                    <a-plane id="ground" position="0 0 0" rotation="-90 0 0" width="4" height="4" material="shader: flat; color: #ffffff"></a-plane>
                    <a-entity id="preview-entity" gltf-model="" position="0 0.5 0" rotation="0 0 0" scale="1 1 1"></a-entity>
                    <a-entity camera position="0 2 4" look-controls></a-entity>
                </a-scene>
            </div>
            <div class="p-4 space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase">Ajustes del Modelo</h3>
                <select id="model-id" class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-sm text-white">
                    <option value="modelo-silla">Silla (Target Index 0)</option>
                    <option value="modelo-tripo">Tripo (Target Index 1)</option>
                </select>
                <div>
                    <label class="text-xs text-slate-400 flex justify-between">Altura (Y) <span id="val-y">0.5</span></label>
                    <input type="range" id="posY" min="-2" max="5" step="0.05" value="0.5" class="w-full" oninput="applyTransforms()">
                </div>
                <div>
                    <label class="text-xs text-slate-400 flex justify-between">Escala <span id="val-s">1.0</span></label>
                    <input type="range" id="scale" min="0.01" max="8" step="0.05" value="1" class="w-full" oninput="applyTransforms()">
                </div>
                <div>
                    <label class="text-xs text-slate-400 flex justify-between">Rotaci√≥n Y <span id="val-r">0</span>¬∞</label>
                    <input type="range" id="rotY" min="0" max="360" step="1" value="0" class="w-full" oninput="applyTransforms()">
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-4">
            <div class="stitch-card p-8 text-center flex-1 flex flex-col justify-center">
                <div class="text-5xl mb-4">üöÄ</div>
                <h2 class="text-xl font-bold mb-2">Publicar en GitHub</h2>
                <p class="text-sm text-slate-400 mb-6 px-4">Esta acci√≥n actualizar√° el archivo <b>index.html</b> con las coordenadas que ves en pantalla.</p>
                <button onclick="publishToGitHub()" id="btn-pub" class="accent-lavender hover:opacity-90 w-full py-4 rounded-2xl font-bold text-lg transition-all shadow-lg shadow-indigo-500/20">
                    GUARDAR CAMBIOS (LIVE)
                </button>
                <p id="status-msg" class="mt-4 text-xs font-mono text-slate-500 italic">Esperando cambios...</p>
            </div>
        </div>
    </div>

    <script>
        // Cargar Token de localStorage
        document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';

        function saveToken() {
            const token = document.getElementById('gh-token').value;
            localStorage.setItem('gh_token', token);
            alert("‚úÖ Token guardado correctamente.");
        }

        // Manejo de archivos locales para previsualizaci√≥n
        function handleFile(input, type) {
            const file = input.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            
            if(type === 'model') {
                document.getElementById('preview-entity').setAttribute('gltf-model', url);
            }
            if(type === 'target') {
                const plane = document.getElementById('ground');
                // Forzamos actualizaci√≥n de textura para que no se vea blanco
                plane.setAttribute('material', `src: ${url}; shader: flat; side: double`);
            }
        }

        // Aplicar transformaciones al visor en tiempo real
        function applyTransforms() {
            const y = document.getElementById('posY').value;
            const s = document.getElementById('scale').value;
            const r = document.getElementById('rotY').value;
            
            // Actualizar etiquetas de texto
            document.getElementById('val-y').innerText = y;
            document.getElementById('val-s').innerText = s;
            document.getElementById('val-r').innerText = r;

            const ent = document.getElementById('preview-entity');
            ent.setAttribute('position', `0 ${y} 0`);
            ent.setAttribute('scale', `${s} ${s} ${s}`);
            ent.setAttribute('rotation', `0 ${r} 0`);
        }

        // L√≥gica de GitHub
        async function publishToGitHub() {
            const token = document.getElementById('gh-token').value;
            const modelId = document.getElementById('model-id').value;
            const msg = document.getElementById('status-msg');
            const btn = document.getElementById('btn-pub');

            if(!token) return alert("‚ö†Ô∏è Error: Introduce tu GitHub Token.");

            btn.disabled = true;
            msg.innerText = "‚è≥ Leyendo repositorio...";

            try {
                const repo = 'vellaescola/xacobeo-ar-experience';
                const url = `https://api.github.com/repos/${repo}/contents/index.html`;

                // 1. Obtener index.html actual
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if(!res.ok) throw new Error("No se pudo acceder al repo. Revisa el Token.");
                
                const data = await res.json();
                let htmlContent = atob(data.content);

                // 2. Preparar nuevas coordenadas
                const posY = document.getElementById('posY').value;
                const scale = document.getElementById('scale').value;
                const rotY = document.getElementById('rotY').value;

                // Regex para encontrar el bloque del modelo seleccionado
                const regex = new RegExp(`id="${modelId}"[\\s\\S]*?position=".*?"[\\s\\S]*?rotation=".*?"[\\s\\S]*?scale=".*?"`, 'g');
                
                // Determinamos el src correcto seg√∫n el ID para no borrarlo
                const assetName = modelId === 'modelo-silla' ? 'silla' : 'tripo';
                const replacement = `id="${modelId}" src="#${assetName}" position="0 ${posY} 0" rotation="0 ${rotY} 0" scale="${scale} ${scale} ${scale}"`;

                if (!regex.test(htmlContent)) {
                    throw new Error("No se encontr√≥ el ID en el index.html. Revisa que el index sea el correcto.");
                }

                htmlContent = htmlContent.replace(regex, replacement);

                // 3. Subir a GitHub
                msg.innerText = "üöÄ Subiendo cambios a GitHub...";
                const push = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Admin Update: ${modelId} transform`,
                        content: btoa(unescape(encodeURIComponent(htmlContent))),
                        sha: data.sha
                    })
                });

                if(push.ok) {
                    msg.innerText = "‚úÖ ¬°CAMBIOS PUBLICADOS! Revisa tu App AR en 30s.";
                    btn.classList.add('accent-emerald');
                    setTimeout(() => {
                        btn.classList.remove('accent-emerald');
                        btn.disabled = false;
                        msg.innerText = "Listo para m√°s cambios.";
                    }, 5000);
                } else {
                    throw new Error("Fallo en el servidor de GitHub.");
                }

            } catch (e) {
                msg.innerText = "‚ùå Error: " + e.message;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
